/* use seed dise dataset */
use $iec/dise/dise_basic_clean, clear

/* merge with other DISE datasets */
foreach dataset in dise_enr_clean dise_facility_clean.dta dise_general_clean {
  merge m:1 dise_state year vilcd schcd using $iec/dise/`dataset'
  drop _merge
}

/* focus on single year, after enaction of scheme */
keep if year == "2006-2007"

/* make all variables lower case */
replace dise_block_name = lower(dise_block_name)
replace dise_state = lower(dise_state)
replace district = lower(district)

/* rename state names */
foreach var in andhra arunachal himachal madhya uttar {
replace dise_state = "`var' pradesh" if dise_state == "`var'-pradesh"
}

replace dise_state = "west bengal" if dise_state == "west-bengal"
replace dise_state = "tamil nadu" if dise_state == "tamil-nadu"
replace dise_state = "andaman nicobar island" if dise_state == "andaman-and-nicobar-islands"
replace dise_state = "dadra nagar haveli" if dise_state == "dadra-and-nagar-haveli"
replace dise_state = "daman diu" if dise_state == "daman-and-diu"
replace dise_state = "jammu kashmir" if dise_state == "jammu-and-kashmir"
replace dise_state = "jammu kashmir" if dise_state == "jammu-&-kashmir"
replace dise_state = "uttarakhand" if dise_state == "uttaranchal"
replace dise_state = "chhattisgarh" if dise_state == "chattisgarh"
replace pc01_state_name = "pondicherry" if pc01_state_name == "puducherry"

/* edit district names */
replace district = "aurangabad" if district == "aurangabad (maharashtra)"

foreach var in east west south north {
  replace district = "`var'" if district == "`var' delhi"
  replace district = "`var'" if district == "`var' sikkim"
}

/* drop collective  NE states entry*/
drop if dise_state == "north-eastern-states"

/* manually rename districts */
replace pc01_district_name = "kamrup" if pc01_district_name == "kamrup-rural"
replace pc01_district_name = "north cachar hills" if pc01_district_name == "dima hasao"
replace pc01_district_name = "bilaspur" if pc01_district_name == "bilaspur (chhattisgarh)"
replace pc01_district_name = "raigarh" if pc01_district_name == "raigarh (chhattisgarh)"
replace pc01_district_name = "bangalore" if pc01_district_name == "bangalore u south"
replace pc01_district_name = "chikmagalur" if pc01_district_name == "chikkamangalore"
replace pc01_district_name = "east nimar" if pc01_district_name == "khandwa" ///
    | pc01_district_name == "burhanpur"
replace pc01_district_name = "west nimar" if pc01_district_name == "khargone"
replace pc01_district_name = "raigarh" if pc01_district_name == "raigarh (maharashtra)"
replace pc01_district_name = "baleshwar" if pc01_district_name == "balasore"
replace pc01_district_name = "kendujhar" if pc01_district_name == "keonjhar"
replace pc01_district_name = "sant ravidas nagar bhadohi" if pc01_district_name == "bhadoi"
replace pc01_district_name = "medinipur" if pc01_district_name == "paschim medinipur" ///
    | pc01_district_name == "purba medinipur"

/* rename key variables */
ren district pc01_district_name
ren dise_state pc01_state_name

/* remove  leading and trailing spaces */
replace dise_block_name = strtrim(dise_block_name)

/* edit school names */
replace school_name = strlower(school_name)
replace school_name = strtrim(school_name)
replace school_name = stritrim(school_name)

/* save pre-merge dataset */
save $tmp/premerge, replace

/* merge with key to get PC01 block names */
merge m:1 pc01_state_name pc01_district_name dise_block_name using $ebb/pc01_dise_key

/* drop merge variable to faciliate second merge */
drop _merge

/* merge with KGBV list */
merge m:1 pc01_state_id pc01_district_id pc01_block_id using $ebb/kgbvs_list_clean

/* save as temporary dataset */
save $tmp/findkgbvs, replace

/* add dummy for potential KGBV status */
gen potential = 0
replace potential = 1 if schtype == "2" & schcat == "4" & kgbvs_operational > 0 ///
    & schmgt != "4" & schmgt != "5"
